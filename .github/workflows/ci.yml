name: CI/CD Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  packages: write
  actions: read

env:
  # Use GHCR images by default
  BACKEND_IMAGE: ghcr.io/manavgup/rag_modulo/backend:latest
  FRONTEND_IMAGE: ghcr.io/manavgup/rag_modulo/frontend:latest
  TEST_IMAGE: ghcr.io/manavgup/rag_modulo/backend:latest

  # CI Environment Variables
  TESTING: true
  SKIP_AUTH: true
  DEVELOPMENT_MODE: true

jobs:
  # Test isolation validation - atomic tests without any environment variables
  test-isolation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies with retry
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: cd backend && poetry install --with dev,test

      - name: Run test isolation checker
        run: |
          export TESTING=true
          export SKIP_AUTH=true
          export DEVELOPMENT_MODE=true
          cd backend && python ../scripts/check_test_isolation.py

      - name: Run atomic tests without environment variables
        run: |
          export TESTING=true
          export SKIP_AUTH=true
          export DEVELOPMENT_MODE=true
          cd backend && poetry run pytest tests/ -m atomic --tb=short -v

  # Fast feedback - lint and unit tests without infrastructure
  lint-and-unit:
    runs-on: ubuntu-latest
    needs: [test-isolation]
    env:
      # Essential environment variables for current atomic tests
      # TODO: Remove these once issue #172 (test isolation) is fixed
      JWT_SECRET_KEY: test-secret-key-for-ci
      RAG_LLM: openai
      WATSONX_INSTANCE_ID: test-instance-id
      WATSONX_APIKEY: test-api-key
      WATSONX_URL: https://test.watsonx.com
      # Additional variables needed by tests
      VECTOR_DB: milvus
      MILVUS_HOST: milvus-standalone
      MILVUS_PORT: 19530
      EMBEDDING_MODEL: sentence-transformers/all-minilm-l6-v2
      DATA_DIR: /tmp/test-data
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            backend/.venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Install dependencies with retry
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            cd backend
            pip install poetry
            poetry config virtualenvs.in-project true
            # Regenerate lock file to ensure sync
            poetry lock
            # Install main, dev, and test groups for CI
            poetry install --with dev,test

      - name: Check formatting
        run: make format-check
        continue-on-error: true  # Don't fail on format issues initially

      - name: Run linting (Ruff + MyPy)
        run: make lint
        continue-on-error: true  # Don't fail on lint issues initially

      - name: Run security checks
        run: make security-check
        continue-on-error: true  # Don't fail on security issues initially

      - name: Run unit tests with coverage
        run: |
          cd backend && poetry run pytest tests/ \
            -m "atomic" \
            --cov=rag_solution \
            --cov-report=term-missing \
            --cov-fail-under=60 \
            --maxfail=5 \
            --tb=short
        continue-on-error: true  # Don't fail on coverage threshold initially

  # Build images once
  build:
    runs-on: ubuntu-latest
    outputs:
      backend-image: ${{ steps.build.outputs.backend-image }}
      frontend-image: ${{ steps.build.outputs.frontend-image }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build images (no push on PRs)
        id: build
        run: |
          # Build with commit SHA for uniqueness
          BACKEND_TAG="ghcr.io/manavgup/rag_modulo/backend:${{ github.sha }}"
          FRONTEND_TAG="ghcr.io/manavgup/rag_modulo/frontend:${{ github.sha }}"

          echo "Building backend image..."
          docker build -t $BACKEND_TAG -f ./backend/Dockerfile.backend ./backend

          echo "Building frontend image..."
          docker build -t $FRONTEND_TAG -f ./frontend/Dockerfile.frontend ./frontend

          echo "Images built successfully (not pushing on PRs)"
          echo "backend-image=$BACKEND_TAG" >> $GITHUB_OUTPUT
          echo "frontend-image=$FRONTEND_TAG" >> $GITHUB_OUTPUT


  # Simple reporting without complex XML parsing
  report:
    needs: [lint-and-unit, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Report results
        run: |
          echo "## CI/CD Results"
          echo "- Lint and Unit Tests: ${{ needs.lint-and-unit.result }}"
          echo "- Build: ${{ needs.build.result }}"

          if [[ "${{ needs.lint-and-unit.result }}" == "failure" || "${{ needs.build.result }}" == "failure" ]]; then
            echo "❌ Critical jobs failed"
            exit 1
          else
            echo "✅ Core jobs passed"
          fi
