name: Test and Issue Creation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  PROJECT_NAME: rag-modulo
  PYTHON_VERSION: "3.12"
  PROJECT_VERSION: "1.0.0"
  # Use GHCR images by default
  BACKEND_IMAGE: ghcr.io/manavgup/rag_modulo/backend:latest
  FRONTEND_IMAGE: ghcr.io/manavgup/rag_modulo/frontend:latest
  TEST_IMAGE: ghcr.io/manavgup/rag_modulo/backend:latest

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        vector_db: [milvus]  # We can add others like chromadb, weaviate, pinecone when needed
      fail-fast: false

    env:
      VECTOR_DB: ${{ matrix.vector_db }}
      # Add your other environment variables from .env here
      COLLECTIONDB_NAME: testdb
      COLLECTIONDB_USER: postgres
      COLLECTIONDB_PASS: postgres
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Create volume directories
      run: make create-volumes

    - name: Pull latest GHCR images
      run: |
        docker pull ${{ env.BACKEND_IMAGE }}
        docker pull ${{ env.FRONTEND_IMAGE }}
        docker pull ${{ env.TEST_IMAGE }}

    - name: Start services
      run: make run-services
      
    - name: Wait for services to be healthy
      run: |
        echo "Waiting for services to be healthy..."
        attempt=1
        max_attempts=30
        while [ $attempt -le $max_attempts ]; do
          if docker compose ps | grep -q "unhealthy\|exit"; then
            echo "Attempt $attempt: Some services are unhealthy or exited"
            docker compose ps
            docker compose logs
            sleep 10
            attempt=$((attempt+1))
          else
            echo "All services are healthy!"
            docker compose ps
            break
          fi
        done
        if [ $attempt -gt $max_attempts ]; then
          echo "Services failed to become healthy after $max_attempts attempts"
          exit 1
        fi

    - name: Run tests
      id: run-tests
      run: |
        make create-test-dirs
        make tests || echo "tests_failed=true" >> $GITHUB_OUTPUT

    - name: Create issues for failed tests
      if: steps.run-tests.outputs.tests_failed == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const xml2js = require('xml2js');
          
          try {
            const xmlData = fs.readFileSync('test-reports/junit.xml', 'utf8');
            const parser = new xml2js.Parser();
            
            parser.parseString(xmlData, async (err, result) => {
              if (err) {
                console.error('Error parsing XML:', err);
                return;
              }
              
              const testcases = result.testsuites.testsuite[0].testcase;
              for (const testcase of testcases) {
                if (testcase.failure) {
                  const title = `[${process.env.VECTOR_DB}] Test Failure: ${testcase.$.name}`;
                  const body = `
                  Test: ${testcase.$.name}
                  Class: ${testcase.$.classname}
                  Vector DB: ${process.env.VECTOR_DB}
                  Error: ${testcase.failure[0]._}
                  
                  This issue was automatically created by the test automation workflow.
                  `;
                  
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: title,
                    body: body,
                    labels: ['test-failure', 'needs-triage', process.env.VECTOR_DB]
                  });
                }
              }
            });
          } catch (error) {
            console.error('Error processing test results:', error);
          }

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ matrix.vector_db }}
        path: |
          test-reports/
          logs/
        retention-days: 7

    - name: Cleanup
      if: always()
      run: make clean