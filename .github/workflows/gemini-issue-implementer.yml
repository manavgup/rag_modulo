name: "Stage 2: AI Implementation (OpenAI Codex)"

# Triggers when the "plan-approved" label is added (human approval)
on:
  issues:
    types: [labeled]

jobs:
  implement-fix:
    # Only run when the "plan-approved" label is added
    if: github.event.label.name == 'plan-approved'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for Branch Collision
        run: |
          BRANCH="fix/issue-${{ github.event.issue.number }}"

          # Check if branch exists on remote
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "⚠️ Branch $BRANCH already exists on remote!"

            gh issue comment ${{ github.event.issue.number }} --body "## ❌ Implementation Blocked: Branch Already Exists

            The branch \`$BRANCH\` already exists in the repository.

            **This usually means:**
            1. A previous AI implementation attempt for this issue exists
            2. Someone manually created this branch
            3. An old PR was closed without deleting the branch

            **To resolve:**
            1. Check if there's an existing PR for this issue
            2. If the PR is closed/merged, delete the branch:
               \`\`\`bash
               git push origin --delete $BRANCH
               \`\`\`
            3. If you want to keep the existing branch, use a different issue number
            4. After cleanup, remove and re-add the \`plan-approved\` label to retry

            **Workflow stopped to prevent conflicts.**"

            exit 1
          fi

          echo "✅ Branch $BRANCH is available"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Implementation Plan
        id: get_plan
        run: |
          # Fetch the latest AI Implementation Plan from issue comments
          PLAN=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq '.[] | select(.body | contains("## 🤖 AI Implementation Plan")) | .body' | head -1)

          if [ -z "$PLAN" ]; then
            echo "❌ No implementation plan found in issue comments"
            gh issue comment ${{ github.event.issue.number }} --body "❌ Implementation failed: No AI Implementation Plan found in issue comments. Please ensure the planning step completed successfully."
            exit 1
          fi

          # Save plan to file (multiline safe)
          echo "$PLAN" > /tmp/implementation_plan.md
          echo "plan_file=/tmp/implementation_plan.md" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Codex Implements Fix
        uses: openai/codex-action@v1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo  # Can write files but no superuser access
          prompt: |
            You are implementing the approved plan for GitHub issue #${{ github.event.issue.number }}.

            ## 📋 Approved Implementation Plan

            $(cat ${{ steps.get_plan.outputs.plan_file }})

            ---

            **Your Task:**
            1. Follow the approved plan above EXACTLY
            2. Create a new branch: `fix/issue-${{ github.event.issue.number }}`
            3. Implement the changes according to the plan
            4. Write/update tests as specified in the plan
            5. Ensure code follows the project's standards (CLAUDE.md)
            6. Run local quality checks if possible
            7. Commit changes with descriptive messages (include DCO sign-off)
            8. Push the branch
            9. Create a pull request with:
               - Title: "fix: [Brief description from issue]"
               - Body: Reference to issue, summary of changes, testing done
               - Link to the original issue

            **Branch Workflow:**
            ```bash
            # Create and checkout new branch
            git checkout -b fix/issue-${{ github.event.issue.number }}

            # After making changes, commit with DCO
            git add .
            git commit -s -m "fix: [descriptive message]

            Fixes #${{ github.event.issue.number }}

            [Detailed description of what was changed and why]"

            # Push branch
            git push -u origin fix/issue-${{ github.event.issue.number }}

            # Create PR
            gh pr create \
              --title "fix: [Brief description]" \
              --body "$(cat <<'PREOF'
            Fixes #${{ github.event.issue.number }}

            ## Changes Made
            [List your changes]

            ## Testing
            [How you tested]

            ## Checklist
            - [ ] Code follows project style guidelines
            - [ ] Tests added/updated
            - [ ] Documentation updated if needed
            - [ ] All CI checks pass
            PREOF
            )" \
              --label "ai-generated"
            ```

            **Quality Guidelines:**
            - Follow existing code patterns
            - Add comprehensive error handling
            - Include docstrings and type hints (Python)
            - Write clear commit messages
            - Keep changes focused on the issue

            **Important:**
            - Do NOT use --yolo mode for destructive operations
            - Ask before making breaking changes
            - Test changes locally when possible
            - Follow the approved plan - don't deviate

      - name: Comment on Issue
        if: success()
        run: |
          # Get the PR number that was just created
          PR_NUM=$(gh pr list --head fix/issue-${{ github.event.issue.number }} --json number --jq '.[0].number')
          gh issue comment ${{ github.event.issue.number }} --body "✅ Implementation complete! Pull request created: #${PR_NUM}

          The PR will now be automatically reviewed by Claude Code Review.
          Please review the changes and merge if everything looks good."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on Failure
        if: failure()
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "❌ Implementation failed. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          You may need to implement this manually."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
