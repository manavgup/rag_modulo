# SPIRE Server Configuration for RAG Modulo
# Reference: docs/architecture/spire-integration-architecture.md
#
# This configuration sets up a SPIRE server for the RAG Modulo platform
# to manage workload identities for AI agents.

server {
    # Bind address for the SPIRE Server API
    bind_address = "0.0.0.0"
    bind_port = "8081"

    # Socket path for local communication
    socket_path = "/tmp/spire-server/private/api.sock"

    # Trust domain for the SPIRE deployment
    trust_domain = "rag-modulo.example.com"

    # Data directory for SPIRE Server data
    data_dir = "/var/lib/spire/server/data"

    # Log configuration
    log_level = "INFO"
    log_format = "json"

    # CA configuration
    ca_subject {
        country = ["US"]
        organization = ["RAG Modulo"]
        common_name = "RAG Modulo SPIRE CA"
    }

    # CA key type and TTL
    ca_key_type = "rsa-2048"
    ca_ttl = "168h"  # 7 days

    # JWT-SVID configuration
    jwt_issuer = "https://spire.rag-modulo.example.com"

    # Default SVID TTL (1 hour for agents)
    default_svid_ttl = "1h"

    # Federation configuration (optional)
    # federation {
    #     bundle_endpoint {
    #         address = "0.0.0.0"
    #         port = 8443
    #     }
    # }
}

plugins {
    # DataStore plugin - stores registration entries and node information
    DataStore "sql" {
        plugin_data {
            database_type = "postgres"
            connection_string = "${SPIRE_DB_CONNECTION_STRING}"
        }
    }

    # NodeAttestor plugin for Kubernetes - attests Kubernetes nodes
    NodeAttestor "k8s_psat" {
        plugin_data {
            clusters = {
                "rag-modulo-cluster" = {
                    service_account_allow_list = ["spire:spire-agent"]
                }
            }
        }
    }

    # KeyManager plugin - manages signing keys
    KeyManager "disk" {
        plugin_data {
            keys_path = "/var/lib/spire/server/keys"
        }
    }

    # Notifier plugin for K8s bundle management
    Notifier "k8sbundle" {
        plugin_data {
            namespace = "spire"
            config_map = "spire-bundle"
        }
    }
}

# Health check configuration
health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}

# Telemetry configuration
telemetry {
    Prometheus {
        host = "0.0.0.0"
        port = 9988
    }
}
