# Production docker-compose - Everything containerized
version: '3.8'

services:
  # Extend infrastructure services
  postgres:
    extends:
      file: docker-compose-infra.yml
      service: postgres

  milvus-etcd:
    extends:
      file: docker-compose-infra.yml
      service: milvus-etcd

  milvus-standalone:
    extends:
      file: docker-compose-infra.yml
      service: milvus-standalone

  minio:
    extends:
      file: docker-compose-infra.yml
      service: minio

  createbuckets:
    extends:
      file: docker-compose-infra.yml
      service: createbuckets

  mlflow-server:
    extends:
      file: docker-compose-infra.yml
      service: mlflow-server

  # Production backend
  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/manavgup/rag_modulo/backend:latest}
    container_name: rag-modulo-backend
    env_file: .env
    environment:
      - MILVUS_HOST=milvus-standalone
      - COLLECTIONDB_HOST=postgres
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - milvus-standalone
      - minio
    networks:
      - app-network
      - rag-network

  # Production frontend
  frontend:
    image: ${FRONTEND_IMAGE:-ghcr.io/manavgup/rag_modulo/frontend:latest}
    container_name: rag-modulo-frontend
    environment:
      - BACKEND_URL=http://backend:8000
    ports:
      - "3000:8080"
    depends_on:
      - backend
    networks:
      - app-network
      - rag-network

volumes:
  postgres_data:
    driver_opts:
      type: none
      device: ${PWD}/volumes/postgres
      o: bind
  etcd_data:
    driver_opts:
      type: none
      device: ${PWD}/volumes/etcd
      o: bind
  minio_data:
    driver_opts:
      type: none
      device: ${PWD}/volumes/minio
      o: bind
  milvus_data:
    driver_opts:
      type: none
      device: ${PWD}/volumes/milvus
      o: bind

networks:
  rag-network:
    driver: bridge
  app-network:
    driver: bridge
